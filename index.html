<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Drupal in 2020</title>
  <meta name="author" content="Larry Garfield">
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">
  <link rel="stylesheet" href="css/reveal.css">
  <link rel="stylesheet" href="palantirnet-theme/css/styles.css" id="theme">
  <!-- Printing and PDF exports -->
  <script>
    var link = document.createElement( 'link' );
    link.rel = 'stylesheet';
    link.type = 'text/css';
    link.href = window.location.search.match( /print-pdf/gi ) ? 'palantirnet-theme/css/print/pdf.css' : 'palantirnet-theme/css/print/paper.css';
    document.getElementsByTagName( 'head' )[0].appendChild( link );
  </script>
  <!--[if lt IE 9]>
  <script src="lib/js/html5shiv.js"></script>
  <![endif]-->

  <style type="text/css">

    dl dt {
      text-align: left;
    }

    dl dd {
      margin-left: 2em;
      text-align: left;
    }

    .struck {
      text-decoration: line-through;
    }

    .reveal p + p {
      margin-top: 1em;
    }

    .struck {
      text-decoration: line-through;
    }

    li.bigdeal {
      font-size: 150%;
      color: Red;
      font-style: italic;
      text-shadow: 3px 3px 10px #990000;
    }

    span.bigdeal {
      font-size: 150%;
      color: Red;
      font-style: italic;
      text-shadow: 3px 3px 10px #990000;
      text-transform: uppercase;
      transition: 500ms;
    }

    p.bigdeal {
      font-size: 200%;
      color: Red;
      font-style: italic;
      text-shadow: 3px 3px 10px #990000;
    }

    .reveal .output {
      border: 1px solid black;
      font-family: monospace;
      padding: 5px;
    }

  </style>

  <script src="palantirnet-theme/js/classer.js"></script>

  <!--<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>-->

</head>
<!-- Change body class to "dark" if you prefer a dark theme, or "light" if you'd rather have a light theme-->
<body class="light">
<div class="reveal">
  <!-- Any section element inside of this container is displayed as a slide -->
  <div class="slides">

    <section>
      <h1>Drupal in 2020</h1>
      <p>
        <small>Presented by <a href="http://www.garfieldtech.com/">Larry Garfield</a> (<a href="http://twitter.com/Crell">@Crell</a>)</small>
      </p>
    </section>
    <section class="l-2up">
      <h2><a href="http://twitter.com/Crell">@Crell</a></h2>
      <div>
        <img src="assets/larry-olaf-hug.jpg" alt="Larry implements Huggable" style="width: 350px; margin: 0" />
      </div>
      <div>
        <ul style="text-wrap: none">
          <li>Senior Architect, <a href="http://www.palantir.net/">Palantir.net</a></li>
          <li style="margin-top: 1em;">Drupal 8 Web Services Lead</li>
          <li style="margin-top: 1em;">Drupal Representative, <a href="http://www.php-fig.org/">PHP-FIG</a></li>
          <li style="margin-top: 1em;">Advisor, Drupal Association</li>
          <li style="margin-top: 1em;"><code>implements Huggable</code></li>
        </ul>
      </div>
    </section>
    <section>
      <section>
        <img src="assets/drupal-8-logo.svg" width="600px" />
        <aside class="notes">
          <ul>
            <li>Going to be great</li>
            <li>Be proud</li>
            <li>Applause for audience who worked on it</li>
            <li>Nothing should be taken as criticism of team</li>
          </ul>
        </aside>
      </section>
      <section>
        <h2>Let's never do that again</h2>
      </section>
      <section>
        <h2>We spent 4 years playing catch up</h2>
      </section>
      <section>
        <p class="bigtext">Wordpress had a <a href="http://wp-api.org/">REST API</a> years ago</p>
        <p class="fragment bigtext">Joomla was responsive by default <a href="https://www.joomla.org/announcements/release-news/5464-joomla-3-0-0-released.html">in 2012</a>.</p>
      </section>
      <section>
        <blockquote class="twitter-tweet" lang="en"><p lang="en" dir="ltr">I&#39;d hate to sound like a hater, but the &#39;breakthru&#39; <a href="https://twitter.com/hashtag/Drupal8?src=hash">#Drupal8</a> features seem like what <a href="https://twitter.com/hashtag/EPiServer?src=hash">#EPiServer</a> 7 had 3 yrs ago <a href="http://t.co/Vi7oGzmvcp">pic.twitter.com/Vi7oGzmvcp</a></p>&mdash; Arild Henrichsen (@ahenrichsen) <a href="https://twitter.com/ahenrichsen/status/620640287220756481">July 13, 2015</a></blockquote>
        <img src="assets/drupal-8-feature-list.png" style="width: 700px" alt="Drupal 8 feature list" data-credit="https://twitter.com/ahenrichsen/status/620640287220756481/photo/1" />
      </section>
      <section>
        <p class="bigtext">The market is moving faster than we are</p>
        <p class="fragment bigtext">Technology is moving even faster.</p>
      </section>
      <section>
        <h2>Since Drupal 8 was started...</h2>
        <ul>
          <li class="fragment">Composer/Packagist</li>
          <li class="fragment">PHP-FIG</li>
          <li class="fragment">Symfony2</li>
          <li class="fragment">Flexbox</li>
          <li class="fragment">PHP 5.4<span class="fragment">, PHP 5.5</span><span class="fragment">, PHP 5.6</span><span class="fragment">, PHP 7?</span></li>
          <li class="fragment">IE 9<span class="fragment">, IE 10</span><span class="fragment">, IE 11</span><span class="fragment">, Edge</span></li>
        </ul>
        <aside class="notes">
          <ul>
            <li>MS released 4 browsers. WAT?</li>
          </ul>
        </aside>
      </section>
      <section>
        <p class="bigtext">We need to get out in front</p>
      </section>
      <section>
        <h2>Drupal 8 release schedule</h2>
        <img src="assets/drupal-8-release-schedule.jpg" alt="Semver releases will help" data-credit="https://www.drupal.org/core/dev-cycle" />
        <p class="fragment">Only part of the solution</p>
      </section>
      <section>
        <h2>Where will we need to be in<br />5 years?</h2>
        <aside class="notes">
          <ul>
            <li>What will the market want?</li>
            <li>What will the tech state of the art be?</li>
            <li>Move that way now, incrementally</li>
          </ul>
        </aside>
      </section>
      <section>
        <img src="assets/saruman-palantir.jpg" style="width: 100%;" alt="I tried to consult a crystal ball..." data-credit="https://thepatriotperspective.wordpress.com/2012/07/29/why-the-pentagon-should-be-suspicious-of-palantir/" />
        <aside class="notes">
          <ul>
            <li>Tried to consult a crystal ball</li>
          </ul>
        </aside>
      </section>
      <section>
        <img src="assets/pippin-palantir.jpg" style="width: 100%;" alt="But that didn't work out so well" data-credit="http://www.elevenwarriors.com/forum/ohio-state-recruiting/2015/07/56554/brendan-ferns" />
        <aside class="notes">
          <ul>
            <li>Didn't work out so well</li>
          </ul>
        </aside>
      </section>
    </section>
    <section>
      <section>
        <h2>Let's look at trends</h2>
      </section>
      <section>
        <h2>Push-web</h2>
        <blockquote>I believe that for the web to reach its full potential, it
          will go through a massive re-architecture and re-platforming in the next
          decade... The future of the web is "push-based", meaning the web will
          be coming to us.</blockquote>
        <p>&mdash;Dries Buytaert, <a href="http://buytaert.net/the-big-reverse-of-the-web">The Big Reverse of the Web</a></p>
        <aside class="notes">
          <ul>
            <li>Push-based, meaning server takes action.</li>
            <li>Queues are insufficient.</li>
          </ul>
        </aside>
      </section>
      <section>
        <h2>Saving the Open Web</h2>
        <blockquote>For the Open Web to win, we first must build websites and
          applications that exceed the user experience of Facebook, Apple, Google,
          etc. Second, we need to take back control of our data.</blockquote>
        <blockquote class="fragment">To deliver the best user experience, you want “loosely-coupled
          architectures with a highly integrated user experience”</blockquote>
        <p class="fragment">&mdash;Dries Buytaert, <a href="http://buytaert.net/winning-back-the-open-web">Winning Back the Open Web</a></p>
      </section>
      <section>
        <h2>Decoupled CMS</h2>
        <p class="fragment bigtext">Separate "editorial" from "presentational" install</p>
        <ul>
          <li class="fragment">Static generator</li>
          <li class="fragment">View-only application</li>
          <li class="fragment">Twin installs (weird!)</li>
          <li class="fragment">Live Content server / presentation server</li>
        </ul>
        <aside class="notes">
          <ul>
            <li>Not JS framework "headless"</li>
            <li>Keep getting clients asking for separate content staging server</li>
            <li>Live server has active connection to presentation server, high traffic</li>
          </ul>
        </aside>
      </section>
      <section>
        <img src="assets/decoupled-cms-schedule.png" alt="Decoupled CMSes let you evolve the front and back end separately" data-credit="https://twitter.com/ToddRoss/status/495245469543849984" />
        <p><a href="https://twitter.com/ToddRoss/status/495245469543849984">Todd Ross Nienkerk: "Future of the CMS"</a></p>
      </section>
      <section>
        <blockquote>HTML, CSS, user interaction, analytics, social media integration,
          public user interaction, etc. are <em>content delivery concerns</em>.  Content
          modeling, workflow, editing, indexing, etc. are <em>content management
          concerns</em>.</blockquote>
        <p>&mdash;Deane Barker, <a href="http://gadgetopia.com/post/7206">Decoupled Content Management 101</a></p>
      </section>
      <section class="l-2up">
        <h2>Headless (JS apps)</h2>
        <div>
          <img src="assets/headless-drupal-horseman.jpg" alt="Headless Drupal" data-credit="https://pantheon.io/blog/headless-websites-whats-big-deal" />
        </div>
        <div>
          <ul>
            <li class="fragment">High-traffic API</li>
            <li class="fragment">... The same API as live content server?</li>
            <li class="fragment">Micro-transactions</li>
          </ul>
        </div>
      </section>
      <section>
        <p class="bigtext">Drupal based on micro-services?</p>
        <h2 class="fragment" style="margin-top: 1em;">Drupal <em>as</em> a microservice?</h2>
        <h2 class="fragment" style="margin-top: 1em;">Drupal as microservice<em>s</em>?</h2>
      </section>
      <section class="l-3up">
        <h2>The Real-Time Web</h2>
        <div class="fragment" style="vertical-align: 50%">
          <p class="bigtext">EventSource/SSE</p>
        </div>
        <div class="fragment">
          <p class="bigtext">Websockets</p>
          <img src="assets/websocket-logo.png" alt="Websockets" data-credit="https://developer.mozilla.org/en-US/docs/Web/Guide/HTML/HTML5" />
        </div>
        <div class="fragment">
          <p class="bigtext">HTTP/2</p>
          <img src="assets/http2-logo.png" alt="HTTP 2" data-credit="https://twitter.com/http_2" />
        </div>
        <p style="margin-top: 1em;" class="fragment bigtext">Persistent connections with server-push</p>
      </section>
      <section>
        <p class="bigtext">Our current way of running Drupal is<br />woefully inadequate</p>
        <aside class="notes">
          <ul>
            <li>No persistent connections</li>
            <li>Expensive bootstrap</li>
            <li>Blocking IO (for REST APIs.)</li>
          </ul>
        </aside>
      </section>
    </section>
    <section>
      <section>
        <h2>The problem is CGI</h2>
      </section>
      <section>
        <h2><a href="https://en.wikipedia.org/wiki/Common_Gateway_Interface">Common Gateway Interface</a></h2>
        <ul>
          <li class="fragment">NCSA, 1993</li>
          <li class="fragment">"specification for calling command line executables"</li>
          <li class="fragment">Pass environment variables to script</li>
          <li class="fragment"><code>$_SERVER</code></li>
        </ul>
        <aside class="notes">
          <ul>
            <li>Older than many people in this room</li>
            <li>Why is $_SERVER so weird?  CGI.</li>
          </ul>
        </aside>
      </section>
      <section>
        <p class="bigtext">Shared nothing design can't keep up</p>
        <ul>
          <li class="fragment">OS overhead</li>
          <li class="fragment">No connection persistence</li>
          <li class="fragment">Wasteful application boot</li>
        </ul>
        <p class="fragment">How much of Drupal 8 is designed around<br />compensating for shared-nothing?</p>
        <aside class="notes">
          <ul>
            <li>Process management, hand-off, even with "FastCGI"</li>
            <li>Persistence: No daemons, no push</li>
            <li>How much do we stress over container and boot performance?</li>
          </ul>
        </aside>
      </section>
      <section>
        <h2>It's time to leave CGI behind</h2>
      </section>
      <section>
        <img src="assets/say-what-baby.jpg" alt="Wait, WHAT?" data-credit="http://aleteia.org/2015/05/21/married-sex-is-the-best-sex-if-you-do-it-right/" />
      </section>
    </section>
    <section>
      <h2>Non-CGI PHP</h2>
      <p class="bigtext fragment">Yes, for reals</p>
    </section>
    <section>
      <section>
        <h2>React PHP</h2>
        <p class="fragment bigtext">Like NodeJS, but in PHP</p>
        <p class="fragment bigtext"><em>The</em> way to do Websockets in PHP today</p>
      </section>
      <section>
        <h2>React web server</h2>
        <pre class="font--20"><code class="php" data-trim>
$i = 0;

$app = function ($request, $response) use (&$i) {
    $i++;

    $text = "This is request number $i.\n";
    $headers = array('Content-Type' => 'text/plain');

    $response->writeHead(200, $headers);
    $response->end($text);
};

$loop = React\EventLoop\Factory::create();
$socket = new React\Socket\Server($loop);
$http = new React\Http\Server($socket);

$http->on('request', $app);

$socket->listen(1337);
$loop->run();
        </code></pre>
        <aside class="notes">
          <ul>
            <li>Ignore boilerplate, notice shared process</li>
            <li>Probably don't want to actually share data...</li>
            <li>Share bootstrap!</li>
            <li>Multiplex?</li>
          </ul>
        </aside>
      </section>
      <section>
        <h2 id="async-io">Asynchronous IO</h2>
        <h2 class="fragment" data-classer="async-io" data-classer-class="struck">Non-Blocking IO</h2>
        <ul>
          <li class="fragment">Tell OS to handle IO for you</li>
          <li class="fragment">Return from call immediately</li>
          <li class="fragment">Check back later</li>
        </ul>
        <p class="fragment">(PHP inherits C's attrocious API)</p>
      </section>
      <section>
        <h2>Non-Blocking IO</h2>
        <pre class="font--20"><code class="php" data-trim>
$socket = socket_create(AF_INET, SOCK_STREAM, SOL_TCP);
socket_set_nonblock($socket);
@socket_connect($socket, $ip_address, $port);
socket_write($socket, $out);

while (true) {
  $sockets = [$socket];
  $null = NULL;
  $changed_sockets = socket_select($sockets, $null, $null, 0);
  if ($changed_sockets == false) {
    // Error
  }
  else if ($changed_sockets > 0) {
      $data = socket_read($socket, 4096);
      // Do somethign with $data.
  }
  else {
    // Do something else for a while.
  }
}
        </code></pre>
        <p class="fragment">React abstracts this out for you.</p>
      </section>
      <section>
        <h2>Promises</h2>
        <p class="fragment">Solving callbacks</p>
        <p class="fragment">Deferred execution on async</p>
      </section>
      <section>
        <h2>Promises</h2>
        <pre class="font--20"><code class="php" data-trim>
function dbFetch($id) {
  $deferred = new React\Promise\Deferred();

  // Execute a Node.js-style function using the callback pattern
  getDataFromDBAsync($id, function ($error, $result) use ($deferred) {
    if ($error) {
      $deferred->reject($error);
    }
    else {
      $deferred->resolve($result);
    }
  });

  // Return the promise
  return $deferred->promise();
}

dbFetch()
  ->then(function ($result) {
      // Deferred resolved, do something with $result
      return $result->fetchRow();

    },
    function ($reason) {
      // error handling
    }
  )
  ->then(function($record) {
    // Do something useful with $record.
  });
        </code></pre>
      </section>
      <section>
        <p><q>Node.js is way faster than PHP!</q></p>
        <p class="fragment bigdeal">Wrong!</p>
        <div class="fragment">
          <p><a href="https://philsturgeon.uk/php/2013/11/12/benchmarking-codswallop-nodejs-v-php/">Benchmarking Codswallop</a>, Phil Sturgeon</p>
          <img src="assets/php-v-node-results2.png" alt="PHP and Node.js are equally fast when async" data-credit="https://philsturgeon.uk/php/2013/11/12/benchmarking-codswallop-nodejs-v-php/" />
        </div>
        <aside class="notes">
          <ul>
            <li>That was on PHP 5.5</li>
            <li>PHP 7 is 2x fast for PHP parts</li>
          </ul>
        </aside>
      </section>
    </section>
    <section>
      <section>
        <h2>Icicle</h2>
      </section>
      <section>
        <h2>Generators</h2>
        <p class="fragment">Shortcut for iterators</p>
        <pre class="fragment font--20"><code class="php" data-trim>
function xrange($start, $end) {
  for($i = $start; $i <= $end; ++$i) {
    yield $i;
  }
}

foreach(xrange(1, 1000000000) as $val) {
  // ...
}
        </code></pre>
        <aside class="notes">
          <ul>
            <li>Calling xrange() returns \Generator implements Iterator</li>
            <li>yield: Pause execution, return value, resume later</li>
            <li>Very low memory usage</li>
            <li>Combine with iterator tools, like calback, filters, etc.</li>
            <li>Methods can be generators, too.</li>
          </ul>
        </aside>
      </section>
      <section>
        <h2>Sending to generators</h2>
        <pre class="font--20"><code class="php" data-trim>
function power($pow) {
  $val = yield;
  while ($val) {
    $result = $val * $val;
    $val = (yield $result);
  }
  yield "Done";
}

$s = power(2);
print $s->send(5) . PHP_EOL;
print $s->send(3) . PHP_EOL;
print $s->send(0) . PHP_EOL;
        </code></pre>
        <pre class="output fragment">
25
9
Done
        </pre>
        <aside class="notes">
          <ul>
            <li>Generators can communicate!</li>
          </ul>
        </aside>
      </section>
      <section>
        <pre class="font--20"><code class="php" data-trim>
function logger($config) {
  $socket = openAsync($config);
  while (true) {
    $val = yield;
    socket_write($socket, $val . PHP_EOL, strlen($val) + 1);
  }
}

$logger = logger([...]);
$logger->send('Foo');
$logger->send('Bar');
        </code></pre>
        <pre class="output fragment">
Foo
Bar
        </pre>
      </section>
      <section>
        <h2>Coroutines</h2>
        <blockquote>Coroutines are computer program components that generalize
          subroutines for nonpreemptive multitasking, by allowing multiple entry
          points for suspending and resuming execution at certain locations.</blockquote>
        <p>&mdash;<a href="https://en.wikipedia.org/wiki/Coroutine">Wikipedia</a></p>
      </section>
      <section>
        <h2>Basic Icicle usage</h2>
        <pre class="font--20"><code class="php" data-trim>
use Icicle\Http\Message\RequestInterface;
use Icicle\Http\Message\Response;
use Icicle\Http\Server\Server;
use Icicle\Loop;

$server = new Server(function (RequestInterface $request) {
    $response = new Response(200);
    yield $response->getBody()->end('Hello, world!');
    yield $response->withHeader('Content-Type', 'text/plain');
});

$server->listen(8080);

echo "Server running at http://127.0.0.1:8080\n";

Loop\run();
        </code></pre>
      </section>

      <section>
        <h2>Promises in Icicle</h2>
        <pre class="font--18"><code class="php" data-trim>
use ...;

$resolver = new Resolver(new Executor('8.8.8.8'));

// Method returning a Generator used to create a Coroutine (a type of promise)
$promise1 = new Coroutine($resolver->resolve('example.com'));

$promise2 = $promise1->then(
    function (array $ips) { // Called if $promise1 is fulfilled.
        $connector = new Connector();
        return new Coroutine($connector->connect($ips[0], 80)); // Return another promise.
        // $promise2 will adopt the state of the promise returned above.
    }
);

$promise2->done(
    function (ClientInterface $client) { // Called if $promise2 is fulfilled.
        echo "Asynchronously connected to example.com:80\n";
    },
    function (Exception $exception) { // Called if $promise1 or $promise2 is rejected.
        echo "Asynchronous task failed: {$exception->getMessage()}\n";
    }
);

Loop\run();
        </code></pre>
      </section>

    </section>
    <section>
      <section>
        <h2>HHVM</h2>
        <ul>
          <li class="fragment">Facebook reimplementation of PHP</li>
          <li class="fragment"><em>Mostly</em> compatible</li>
          <li class="fragment"><em>Much</em> faster than 5.6 (on par with 7)</li>
        </ul>
      </section>
      <section>
        <h2>Hack</h2>
        <ul>
          <li class="fragment">Extended PHP language</li>
          <li class="fragment">New syntax!</li>
          <li class="fragment">Had scalar types before they were cool</li>
          <li class="fragment">Short lambdas, generics, shapes, constructor promotion...</li>
        </ul>
        <p class="fragment">And...</p>
      </section>
      <section>
        <h2>Native Async</h2>
        <pre class="font--18"><code class="php" data-trim>
async function hello() {
    return "Hello World";
}

async function goodbye() {
    return "Goodbye, everybody!";
}

async function run(array $handles) {
    await AwaitAllWaitHandle::fromArray($handles);
  return array_map(function ($handle) { return $handle->result(); }, $handles);
}

$results = run(array(hello(), goodbye()))->getWaitHandle()->join();
print_r($results);
        </code></pre>
        <pre class="output">
Array
(
 [0] => Hello World
 [1] => Goodbye, everybody!
)
        </pre>
        <aside class="notes">
          <ul>
            <li>async returns WaitHandler object</li>
          </ul>
        </aside>
      </section>
      <section>
        <h2>Native Async with I/O</h2>
        <pre class="font--18"><code class="php" data-trim>
async function fibonacci_gen($num) {
  $n1 = 0; $n2 = 1; $n3 = 1;
  for ($i = 2; $i < $num; ++$i) {
    $n3 = $n1 + $n2;
    $n1 = $n2;
    $n2 = $n3;
    if (!($i % 100)) {
      // Give other tasks a chance to do something
      // every 100th iteration
      await RescheduleWaitHandle::create(
        RescheduleWaitHandle::QUEUE_DEFAULT,
        0,
      );
    }
  }
  return $n3;
}
$results = run(array(
  "web"  => curl_exec_await("http://example.com"),
  "sql"  => mysql_async_query($conn, "SELECT * FROM user"),
  "disk" => file_async_contents("/var/log/access.log"),
  "mc"   => memcached_async_get("somekey"),
  "fib"  => fibonacci_gen(2000),
))->getWaitHandle()->join();
        </code></pre>
        <aside class="notes">
          <ul>
            <li>Now imagine each of those coroutines is a block...</li>
          </ul>
        </aside>
      </section>
    </section>
    <section>
      <section>
        <h2>Forking PHP!</h2>
      </section>
      <section>
        <h2><a href="https://github.com/palantirnet/kiwi">Kiwi</a></h2>
          <pre class="font--20"><code class="php" data-trim>
$children = array();
$num_processors = 3;

// Spawn off children to do work.
for ($child_id = 1; $child_id <= $num_processors; ++$child_id) {
    $pid = pcntl_fork();
    if ($pid == -1) {
        die('could not fork');
    }
    else if ($pid) {
        // This is the parent. Do nothing here but let the loop complete.
        $children[] = $pid;
    }
    else {
        // This is the child.
        do_child_stuff(...);
        // Kill the child process when done.
        exit(0);
    }
}
// Wait for all of the spawned children to die.
$status = 0;
foreach ($children as $pid) {
    pcntl_waitpid($pid, $status);
}
        </code></pre>
        <aside class="notes">
          <ul>
            <li>CLI task worker for large datasets, Field Museum</li>
            <li>Shared mem up until pcntl_fork(), split after</li>
            <li>Bootstrap app, wait on socket, fork!</li>
            <li>Pre-create children, send messages with IPC (Apache!)</li>
            <li>Each process can do own async</li>
          </ul>
        </aside>
      </section>
<section>
        <h2>Forking server</h2>
          <pre class="font--20"><code class="php" data-trim>
function server_loop($address, $port) {
  $sock = socket_create(AF_INET, SOCK_STREAM, 0);
  socket_bind($sock, $address, $port);
  socket_listen($sock, 0);
  socket_set_nonblock($sock);

  while (true) {
    $connection = @socket_accept($sock);
    // No incoming messages, check again later.
    if ($connection === false) {
      usleep(100);
    }
    elseif ($connection > 0) {
      $pid = pcntl_fork();
      if ($pid == -1) {
        die('could not fork');
      }
      else if ($pid) {
        // This is the parent. Do nothing here but let the loop complete.
      }
      else {
        // This is the child.
        do_child_stuff(...);
        // Kill the child process when done.
        exit(0);
      }
    }
  }
}
        </code></pre>
        <aside class="notes">
          <ul>
            <li>Note: Buggy, error handling removed. :-)</li>
            <li>Various libs to wrap up into nicer API</li>
          </ul>
        </aside>
      </section>
      <section>
        <p class="bigtext"><a href="https://github.com/icicleio/concurrent">Icicle Concurrent</a></p>
        <p class="bigtext">In development, Process manager with Channels for IPC</p>
      </section>
    </section>
    <section>
      <section>
        <h2>Who will win?</h2>
      </section>
      <section>
        <img src="assets/8ball-ask-again.gif" width="400px" alt="Ask again later; I can't predict the future" data-credit="http://www.swissarmylibrarian.net/2008/06/" />
      </section>
      <section>
        <h1>¯\_(ツ)_/¯</h1>
      </section>
      <section>
        <p class="bigtext">CGI won't go away entirely</p>
        <p class="fragment bigtext">We just need to work without it</p>
        <p class="fragment bigtext">Yes, we will need both!</p>
        <aside class="notes">
          <ul>
            <li>How do we make a CGI Drupal and an async Drupal?</li>
            <li>How do we make a monolithic Drupal and a decoupled Drupal?</li>
          </ul>
        </aside>
      </section>
      <section>
        <h2>What we need</h2>
        <p class="fragment bigtext">Different configurations of common<br /><span id="drupal-components">Drupal components</span></p>
        <span class="fragment" data-classer="drupal-components" data-classer-class="bigdeal"></span>
        <aside class="notes">
          <ul>
            <li>A clue!</li>
          </ul>
        </aside>
      </section>
      <section>
        <p class="bigtext">We need components that can run in any mode!</p>
      </section>
      <section>
        <h2>Resuable components</h2>
        <ul>
          <li class="fragment">Stateless <span class="fragment">(Not one single global!)</span></li>
          <li class="fragment">No request(stack) dependencies</li>
          <li class="fragment">Container-free</li>
          <li class="fragment">Isolated IO</li>
          <li class="fragment">As little custom code as possible</li>
        </ul>
        <p class="fragment">Dare I say, pure functional? <span class="fragment">(I dare)</span></p>
        <aside class="notes">
          <ul>
            <li>Stateless: No state makes it reentrant; value objects</li>
            <li>Request: Context tracking a nightmare</li>
            <li>Container: Probably want different container</li>
            <li>IO: Probably have to rewrite it for each mode</li>
            <li>No custom: Lot of work, encourages separation</li>
          </ul>
        </aside>
      </section>
      <section>
        <p class="bigtext">The same clean-code standards we've been pushing for years!</p>
        <p class="fragment bigtext">This is why</p>
      </section>
      <section>
        <h2>Challenges</h2>
        <ul>
          <li class="fragment">Entity API: <span class="fragment">too many statics, service dependencies</span></li>
          <li class="fragment">Render API: <span class="fragment">Render context?</span></li>
          <li class="fragment">ContainerAware: <span class="fragment">Coupled to one container</span></li>
          <li class="fragment">RequestStack: <span class="fragment">Subrequests, not async</span></li>
        </ul>
        <p class="fragment">Separate repos?</p>
        <aside class="notes">
          <ul>
            <li>Render context could go either way if async</li>
          </ul>
        </aside>
      </section>
      <section>
        <p class="bigtext">Thread-safe code can easily be used in CGI mode, but not vice versa.</p>
        <p class="fragment bigtext">It's also far more testable.</p>
      </section>
      <section>
        <p class="bigtext">This is within sight...</p>
        <div class="fragment">
          <p class="bigtext">... because Drupal 8</p>
          <img src="assets/drupal-8-logo.svg" alt="Drupal 8 got us closer" />
          <aside class="notes">
            <ul>
              <li>Drupal 8 is closer to this vision than Drupal 7 is to Drupal 8</li>
              <li>As long as we don't slide backward</li>
            </ul>
          </aside>
        </div>
      </section>
    </section>
    <section>
      <section>
        <p class="bigtext"><q>But what if you're wrong?</q></p>
        <p>&mdash;Everyone in this room</p>
      </section>
      <section>
        <h2>Left with...</h2>
        <ul>
          <li class="fragment">Highly decoupled...</li>
          <li class="fragment">Highly testable...</li>
          <li class="fragment">Resuable...</li>
          <li class="fragment">Sharable...</li>
        </ul>
        <p class="fragment bigtext">Components</p>
      </section>
      <section>
        <h1>Win!</h1>
        <img src="assets/minion-win.gif" alt="We still win" data-credit="https://funnyjunk.com/funny_gifs/4816070/Whenever+i+win+an+argument+with+my+girl/" />
      </section>
    </section>
    <section>
      <section>
        <h2>Tools</h2>
        <ul>
          <li><a href="http://www.reactphp.org/">React PHP</a></li>
          <li><a href="http://icicle.io">Icicle</a></li>
          <li><a href="https://github.com/asyncphp/doorman">Doorman</a></li>
          <li><a href="http://docs.hhvm.com/">HHVM</a></li>
        </ul>
      </section>
      <section>
        <h2>PHP Resources</h2>
        <ul>
          <li><a href="http://php.net/manual/en/language.generators.overview.php">Generators</a></li>
          <li><a href="http://php.net/manual/en/ref.pcntl.php">PHP process control</a> (PCNTL)</li>
        </ul>
      </section>
      <section>
        <h2>Further reading</h2>
        <ul>
          <li><a href="http://www.sitepoint.com/an-introduction-into-event-loops-in-php/">An Introduction to Event Loops</a></li>
          <li>Multi-process PHP by Chris Pitt, <a href="https://medium.com/@assertchris/multi-process-php-94a4e5a4be05">Part 1</a>, <a href="https://medium.com/@assertchris/a-while-ago-i-wrote-about-using-exec-and-shell-commands-to-manage-multiple-php-processes-511f2be5d30d">Part 2</a>, <a href="https://medium.com/@assertchris/event-loops-84978080389c">Part 3</a></li>
          <li><a href="https://nikic.github.io/2012/12/22/Cooperative-multitasking-using-coroutines-in-PHP.html">Cooperative Multi-tasking using coroutines (in PHP!)</a>, </li>
          <li><a href="http://www.slideshare.net/auroraeosrose/socket-programming-with-php">Socket Programming with PHP</a>, by Elizabeth Smith</li>
          <li><a href="http://hhvm.com/blog/7091/async-cooperative-multitasking-for-hack">Async Cooperative Multitasking for Hack</a>, by Sara Golemon</li>
        </ul>
      </section>
    </section>

    <section id="final-slide">
      <h2>Larry Garfield</h2>
      <p>Senior Architect, <a href="http://www.palantir.net/">Palantir.net</a></p>
      <p>Making the Web a Better Place</p>
      <p>Keep tabs on our work at <a href="http://twitter.com/Palantir">@Palantir</a></p>
      <p>Want to hear about <a href="http://eepurl.com/ws6uj">what we're doing</a>?</p>
    </section>
  </div>

  <footer class="footer">
    <a class="logo-wrapper" href="https://www.palantir.net/" title="Link to Palantir.net's website">
      <div class="logo">
        <p>Palantir.net</p>
      </div>
    </a>
  </footer>

</div>

<script src="lib/js/head.min.js"></script>
<script src="js/reveal.js"></script>

<script>

  // Full list of configuration options available at:
  // https://github.com/hakimel/reveal.js#configuration
  Reveal.initialize({
    controls: true,
    progress: true,
    history: true,
    center: true,

    transition: 'slide', // none/fade/slide/convex/concave/zoom

    // Optional reveal.js plugins
    dependencies: [
      { src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
      { src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
      { src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
      { src: 'plugin/highlight/highlight.js', async: true, condition: function() { return !!document.querySelector( 'pre code' ); }, callback: function() { hljs.initHighlightingOnLoad(); } },
      { src: 'plugin/zoom-js/zoom.js', async: true },
      { src: 'plugin/notes/notes.js', async: true }
    ]
  });

</script>

</body>
</html>
